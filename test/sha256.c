#include <stdint.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>
#include "sha2.h"

#define TEST_ITERATIONS 1000000

void print_buffer_hex(const unsigned char *buffer, size_t size) {
    for (size_t i = 0; i < size; i++) {
        printf("0x%02x,", buffer[i]); // %02x formats each byte as 2-digit hex
    };
    printf("\n");
}

void test(const unsigned char *input,unsigned int len,const unsigned char *expected_output)
{
	unsigned char output_hash[32];

	memset(output_hash,0,32);
	sha256(input,len,output_hash);

	if(memcmp(expected_output, output_hash, 32)) {
		printf("sha256 hash failed to calculate correctly.\n");
		printf("Calculated:\n");
		print_buffer_hex(output_hash,32);
		printf("Expected:\n");
		print_buffer_hex(expected_output,32);
		exit(-1);
	}
}

int main(int argc, char **argv)
{
	// Perform a simple test first
	{
		const unsigned char data[]="Test";
		const unsigned char expected_output[32] = {
			0x53,0x2e,0xaa,0xbd,0x95,0x74,0x88,0x0d,
			0xbf,0x76,0xb9,0xb8,0xcc,0x00,0x83,0x2c,
			0x20,0xa6,0xec,0x11,0x3d,0x68,0x22,0x99,
			0x55,0x0d,0x7a,0x6e,0x0f,0x34,0x5e,0x25
		};
		test(data,sizeof(data)-1,expected_output);
	}

	// Test a random array of 64 bytesa
	{
		unsigned char data[64] = {
			0x97,0x47,0x6e,0xa0,0x5f,0x7b,0x9c,0x3d,
			0x2a,0xe1,0xb1,0x0f,0x45,0x4c,0x64,0x86,
			0x93,0x7f,0x76,0xf7,0x2d,0x79,0x54,0x4a,
			0x9e,0xf4,0x4e,0xae,0x9c,0xd4,0xf6,0xdc,
			0xf2,0x01,0x1d,0x5d,0x22,0xfe,0x7f,0x0f,
			0xe6,0x67,0x84,0x04,0x5b,0x03,0x87,0xd2,
			0xe8,0x61,0x7d,0x93,0x2e,0x41,0x03,0xdd,
			0xae,0xe1,0x7c,0xbc,0xf5,0x68,0x4f,0x78
		};
        	const unsigned char expected_output[32] = {
			0x69,0xe2,0xcf,0xe4,0xc4,0x41,0xef,0x38,
			0x83,0x12,0xc7,0xc8,0xd1,0x58,0xcb,0xfe,
			0xa3,0xda,0xb2,0x3e,0xa1,0xe0,0xa2,0x46,
			0xbd,0x03,0x02,0xb0,0x3e,0x73,0xe0,0xb5,
        	};
        	test(data,sizeof(data),expected_output);
	}

	// Test a random array of 256 bytesa
        {
		struct timeval start_time, end_time;
		double elapsed_time;

                unsigned char data[256] = {
                        0x97,0x47,0x6e,0xa0,0x5f,0x7b,0x9c,0x3d,0x2a,0xe1,0xb1,0x0f,0x45,0x4c,0x64,0x86,
                        0x93,0x7f,0x76,0xf7,0x2d,0x79,0x54,0x4a,0x9e,0xf4,0x4e,0xae,0x9c,0xd4,0xf6,0xdc,
                        0xf2,0x01,0x1d,0x5d,0x22,0xfe,0x7f,0x0f,0xe6,0x67,0x84,0x04,0x5b,0x03,0x87,0xd2,
                        0xe8,0x61,0x7d,0x93,0x2e,0x41,0x03,0xdd,0xae,0xe1,0x7c,0xbc,0xf5,0x68,0x4f,0x78,
                        0x97,0x47,0x6e,0xa0,0x5f,0x7b,0x9c,0x3d,0x2a,0xe1,0xb1,0x0f,0x45,0x4c,0x64,0x86,
                        0x93,0x7f,0x76,0xf7,0x2d,0x79,0x54,0x4a,0x9e,0xf4,0x4e,0xae,0x9c,0xd4,0xf6,0xdc,
                        0xf2,0x01,0x1d,0x5d,0x22,0xfe,0x7f,0x0f,0xe6,0x67,0x84,0x04,0x5b,0x03,0x87,0xd2,
                        0xe8,0x61,0x7d,0x93,0x2e,0x41,0x03,0xdd,0xae,0xe1,0x7c,0xbc,0xf5,0x68,0x4f,0x78,
                        0x97,0x47,0x6e,0xa0,0x5f,0x7b,0x9c,0x3d,0x2a,0xe1,0xb1,0x0f,0x45,0x4c,0x64,0x86,
                        0x93,0x7f,0x76,0xf7,0x2d,0x79,0x54,0x4a,0x9e,0xf4,0x4e,0xae,0x9c,0xd4,0xf6,0xdc,
                        0xf2,0x01,0x1d,0x5d,0x22,0xfe,0x7f,0x0f,0xe6,0x67,0x84,0x04,0x5b,0x03,0x87,0xd2,
                        0xe8,0x61,0x7d,0x93,0x2e,0x41,0x03,0xdd,0xae,0xe1,0x7c,0xbc,0xf5,0x68,0x4f,0x78,
                        0x97,0x47,0x6e,0xa0,0x5f,0x7b,0x9c,0x3d,0x2a,0xe1,0xb1,0x0f,0x45,0x4c,0x64,0x86,
                        0x93,0x7f,0x76,0xf7,0x2d,0x79,0x54,0x4a,0x9e,0xf4,0x4e,0xae,0x9c,0xd4,0xf6,0xdc,
                        0xf2,0x01,0x1d,0x5d,0x22,0xfe,0x7f,0x0f,0xe6,0x67,0x84,0x04,0x5b,0x03,0x87,0xd2,
                        0xe8,0x61,0x7d,0x93,0x2e,0x41,0x03,0xdd,0xae,0xe1,0x7c,0xbc,0xf5,0x68,0x4f,0x78

                };
                const unsigned char expected_output[32] = {
			0x5b,0xe3,0xc6,0xab,0x16,0x56,0xa7,0x95,
			0x00,0x25,0x89,0x11,0x67,0xed,0x8e,0xb3,
			0x7e,0x27,0xbd,0x64,0x27,0xbb,0x5f,0x58,
			0x9a,0xec,0xa4,0x5f,0x80,0xa6,0x0d,0x37
                };
                test(data,sizeof(data),expected_output);

		// Do a quick performance test
		gettimeofday(&start_time, NULL);
        	for(int x=0;x<TEST_ITERATIONS;x++) {
			 test(data,sizeof(data),expected_output);
        	}
		gettimeofday(&end_time, NULL);

		elapsed_time=(1000000 * end_time.tv_sec + end_time.tv_usec) - (1000000 * start_time.tv_sec + start_time.tv_usec);
		printf("Elapsed time=%.1fms, Managed to do %.1f SHA256 iterations/s\n",elapsed_time/1000,TEST_ITERATIONS/elapsed_time*1000000);
        }

	printf("All sha256() tests passed.\n");
	return(0);
}
